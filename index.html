<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario – OneDrive (Actualizado)</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

  <!-- XLSX Reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --soft:#1b2741;
      --text:#e9eefb;
      --muted:#a9b6d3;
    }

    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    .card{
      background:var(--card);
      border:1px solid var(--soft);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }

    .toolbar .field{
      display:flex;
      gap:8px;
      align-items:center;
      background:var(--soft);
      border-radius:12px;
      padding:8px 10px;
    }

    .toolbar input, .toolbar select{
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      min-width:160px;
    }

    .btn{
      background:#2a7ef0;
      color:white;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:600;
    }

    #popup{
      position:fixed;
      top:20px;
      right:20px;
      background:#28a745;
      color:white;
      padding:12px 20px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      opacity:0;
      pointer-events:none;
      transition:all .4s ease;
      font-size:15px;
      z-index:9999;
    }

    #popup.show{
      opacity:1;
      transform:translateY(0px);
    }

    #table{ border-radius:12px; overflow:hidden; height:600px; }

    .status{ font-size:12px; color:#c3cfe7; white-space:pre-wrap }
  </style>
</head>

<body>
  <div id="popup">Inventario actualizado correctamente</div>

  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 8px 0; font-size:20px;">Inventario desde OneDrive</h1>

      <div class="toolbar" role="group">
        <div class="field"><input id="q" placeholder="Buscar…" /></div>
        <div class="field">
          <span>Agrupar:</span>
          <select id="groupBy">
            <option value="none">Sin agrupación</option>
            <option value="FAMILIA">Familia</option>
            <option value="MARCA">Marca</option>
          </select>
        </div>

        <button id="reloadBtn" class="btn">Recargar</button>
      </div>

      <div class="status" id="status">Listo.</div>
      <div id="table"></div>
    </div>
  </div>

<script>
// URL RAW del archivo Excel en OneDrive
const XLSX_URL =
  "https://onedrive.live.com/download?resid=31739D16458EAC44!110&authkey=!ERyMsV4zXjpGkyhI";

// Popup verde
function showPopup(){
  const p = document.getElementById("popup");
  p.classList.add("show");
  setTimeout(() => p.classList.remove("show"), 3500);
}

function pick(row, aliases){
  for(const a of aliases){
    for(const k of Object.keys(row)){
      if(!k) continue;
      const kk = k.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim().toUpperCase();
      const aa = a.normalize("NFD").replace(/\p{Diacritic}/gu,"").trim().toUpperCase();
      if(kk === aa) return row[k];
    }
  }
  return "";
}

function fotoFormatter(cell){
  const raw = (cell.getValue()||"").toString().trim();
  if(!raw) return "";
  return `<img style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #273557"
    src="${raw}" onerror="this.style.display='none'">`;
}

let table = new Tabulator("#table", {
  layout:"fitColumns",
  placeholder:"Sin datos",
  columns:[
    {title:"Código", field:"CODIGO", width:120},
    {title:"Nombre", field:"NOMBRE", minWidth:160},
    {title:"Detalle", field:"DETALLE", minWidth:240},
    {title:"Cantidad", field:"CANTIDAD", hozAlign:"right", width:120},
    {title:"Marca", field:"MARCA", width:140},
    {title:"Familia", field:"FAMILIA", width:140},
    {title:"Foto", field:"FOTO", formatter:fotoFormatter, width:110, hozAlign:"center"},
  ]
});

function setStatus(t){
  document.getElementById("status").textContent = t;
}

// === Cargar desde OneDrive ===
async function loadFromOneDrive(){
  try{
    setStatus("Descargando archivo desde OneDrive…");

    const url = XLSX_URL + "&_ts=" + Date.now(); // evitar caché
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);

    const blob = await res.arrayBuffer();
    const wb = XLSX.read(blob, {type:"array"});

    const ws = wb.Sheets["DATA"];
    if(!ws) throw new Error("La hoja 'DATA' no existe en el archivo");

    const raw = XLSX.utils.sheet_to_json(ws, {defval:""});

    const rows = raw.map(r => ({
      CODIGO:   pick(r, ["CODIGO","CÓDIGO","CODE","ID","SKU"]).toString(),
      NOMBRE:   pick(r, ["NOMBRE","NAME","PRODUCTO","ITEM"]).toString(),
      DETALLE:  pick(r, ["DETALLE","DESCRIPCION","DESCRIPCIÓN"]).toString(),
      MARCA:    pick(r, ["MARCA","BRAND"]).toString(),
      FAMILIA:  pick(r, ["FAMILIA","FAMILY","CATEGORÍA"]).toString(),
      CANTIDAD: Number(pick(r, ["CANTIDAD","QTY","QUANTITY"])) || 0,
      FOTO:     pick(r, ["FOTO","IMAGEN","IMAGE"]).toString(),
    }));

    table.replaceData(rows);
    setStatus("Inventario actualizado desde OneDrive.");

    showPopup(); // mostrar popup verde
  }
  catch(e){
    setStatus("ERROR: " + e.message);
    console.error(e);
  }
}

// Botón manual
document.getElementById("reloadBtn").addEventListener("click", loadFromOneDrive);

// Actualización automática cada 5 minutos
setInterval(loadFromOneDrive, 300000);

// Primera carga
loadFromOneDrive();

// Buscador
document.getElementById("q").addEventListener("input", e=>{
  const v = (e.target.value||"").trim().toLowerCase();
  if(!v){ table.clearFilter(true); return; }
  table.setFilter([
    {field:"CODIGO", type:"like", value:v},
    {field:"NOMBRE", type:"like", value:v},
    {field:"DETALLE", type:"like", value:v},
  ]);
});

// Agrupación
document.getElementById("groupBy").addEventListener("change", e=>{
  const mode = e.target.value;
  if(mode==="FAMILIA") table.setGroupBy("FAMILIA");
  else if(mode==="MARCA") table.setGroupBy("MARCA");
  else table.setGroupBy();
});
</script>
</body>
</html>
