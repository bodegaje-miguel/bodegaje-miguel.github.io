<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario â€“ Google Sheets</title>

  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --soft:#1b2741;
      --text:#e9eefb;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    .card{
      background:var(--card);
      border:1px solid var(--soft);
      border-radius:16px;
      padding:16px;
    }
    .toolbar{
      display:flex;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .toolbar input, .toolbar select{
      background:#1b2741;
      border:none;
      color:white;
      padding:8px 10px;
      border-radius:8px;
    }
    .btn{
      background:#2a7ef0;
      color:white;
      border:none;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    #table{ height:600px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Inventario desde Google Sheets</h2>

    <div class="toolbar">
      <input id="q" placeholder="Buscarâ€¦" />
      <select id="groupBy">
        <option value="none">Sin agrupaciÃ³n</option>
        <option value="FAMILIA">Familia</option>
        <option value="MARCA">Marca</option>
      </select>
      <button id="reloadBtn" class="btn">Recargar</button>
    </div>

    <div id="table"></div>
  </div>
</div>

<script>
/* ================= FUENTES ================= */
const CANDIDATES = [
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUkpzEC6aZsl0Ur9f3Jwu3NcuZBq2tzrT_weH8QamLt7qsvJMzUKWkZfc-xNX7Pw/pub?output=csv",
  "https://docs.google.com/spreadsheets/d/1UCJUvGvb2tXTv_zsx0SKFwNdDj_uVR2Hf/gviz/tq?tqx=out:csv&gid=1315400324"
];

/* ================= UTIL ================= */
function pick(row, aliases){
  for(const a of aliases){
    for(const k of Object.keys(row)){
      const kk = k.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      const aa = a.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      if(kk === aa) return row[k];
    }
  }
  return "";
}

/* ================= TABULATOR ================= */
let table = new Tabulator("#table", {
  layout:"fitColumns",
  placeholder:"Sin datos",

  /* ðŸ”´ AQUÃ SE OCULTA LA FILA COMPLETA */
  rowFormatter:function(row){
    const data = row.getData();
    const lote = (data.LOTE || "").toString().trim().toUpperCase();

    if(lote === "BLOQUEO"){
      row.getElement().style.display = "none";
    }
  },

  columns:[
    {title:"CÃ³digo", field:"CODIGO", width:120},
    {title:"Nombre", field:"NOMBRE", minWidth:160},
    {title:"Detalle", field:"DETALLE", minWidth:240},
    {title:"Cantidad", field:"CANTIDAD", width:100, hozAlign:"right"},
    {title:"Marca", field:"MARCA", width:140},
    {title:"Familia", field:"FAMILIA", width:140},
    {title:"Lote", field:"LOTE", width:120},
  ]
});

/* ================= CARGA ================= */
async function loadAny(){
  for(const url of CANDIDATES){
    try{
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error();

      const text = await res.text();
      const wb = XLSX.read(text, {type:"string"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const raw = XLSX.utils.sheet_to_json(ws, {defval:""});

      const rows = raw.map(r => ({
        CODIGO: pick(r, ["CODIGO","ID","SKU"]),
        NOMBRE: pick(r, ["NOMBRE","PRODUCTO"]),
        DETALLE: pick(r, ["DETALLE","DESCRIPCION"]),
        MARCA: pick(r, ["MARCA"]),
        FAMILIA: pick(r, ["FAMILIA","CATEGORIA"]),
        CANTIDAD: Number(pick(r, ["CANTIDAD","QTY"])) || 0,
        LOTE: pick(r, ["LOTE","BLOQUEO","ESTADO"]),
      }));

      table.replaceData(rows);
      return;

    }catch(e){}
  }
}

/* ================= BUSCAR ================= */
document.getElementById("q").addEventListener("input", e => {
  const v = e.target.value.toLowerCase();

  table.setFilter(data =>
    data.CODIGO.toLowerCase().includes(v) ||
    data.NOMBRE.toLowerCase().includes(v) ||
    data.DETALLE.toLowerCase().includes(v)
  );
});

/* ================= AGRUPAR ================= */
document.getElementById("groupBy").addEventListener("change", e => {
  if(e.target.value === "none") table.setGroupBy();
  else table.setGroupBy(e.target.value);
});

/* ================= EVENTOS ================= */
document.getElementById("reloadBtn").addEventListener("click", loadAny);

loadAny();
</script>
</body>
</html>
