  <!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario – Google Sheets</title>

<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1220; --card:#121a2b; --soft:#1b2741;
  --text:#e9eefb; --hl:#ffd54f;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
.card{
  background:var(--card);
  border:1px solid var(--soft);
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
}
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  margin-bottom:12px;
}
.toolbar .field{
  display:flex;
  gap:8px;
  align-items:center;
  background:var(--soft);
  border-radius:12px;
  padding:8px 10px;
}
.toolbar input,.toolbar select{
  background:transparent;
  border:none;
  outline:none;
  color:var(--text);
  font-size:14px;
  min-width:160px;
}
.btn{
  background:#2a7ef0;
  color:white;
  border:none;
  border-radius:12px;
  padding:10px 14px;
  cursor:pointer;
  font-weight:600;
}
.counter{
  margin-left:auto;
  font-weight:600;
}
#table{border-radius:12px;overflow:hidden;height:600px}
mark{
  background:var(--hl);
  color:black;
  padding:0 2px;
  border-radius:3px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1 style="margin:0 0 8px 0;font-size:20px">Inventario desde Google Sheets</h1>

    <div class="toolbar">
      <div class="field">
        <input id="q" placeholder="Buscar…" />
      </div>

      <div class="field">
        <span>Agrupar:</span>
        <select id="groupBy">
          <option value="none">Sin agrupación</option>
          <option value="FAMILIA">Familia</option>
          <option value="MARCA">Marca</option>
        </select>
      </div>

      <button id="exportBtn" class="btn">Exportar visibles</button>

      <div class="counter" id="counter">Visibles: 0</div>
    </div>

    <div id="table"></div>
  </div>
</div>

<script>
/* ================= FUENTES ================= */
const CANDIDATES=[
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUkpzEC6aZsl0Ur9f3Jwu3NcuZBq2tzrT_weH8QamLt7qsvJMzUKWkZfc-xNX7Pw/pub?output=csv"
];

/* ================= HELPERS ================= */
function pick(row, aliases){
  for(const a of aliases){
    for(const k of Object.keys(row)){
      if(!k) continue;
      const kk=k.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      const aa=a.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      if(kk===aa) return row[k];
    }
  }
  return "";
}
function driveImg(url){
  if(!url) return "";
  const m=url.match(/\/file\/d\/([^/]+)\//);
  return m?`https://drive.google.com/uc?export=view&id=${m[1]}`:url;
}

/* ================= FILTRO GLOBAL ================= */
let searchValue="";

function filtroGlobal(data){
  const estatus=(data.ESTATUS2||"").trim().toUpperCase();
  if(estatus==="BLOQUEO") return false;

  if(!searchValue) return true;

  const v=searchValue;
  return (
    data.CODIGO.toLowerCase().includes(v) ||
    data.NOMBRE.toLowerCase().includes(v) ||
    data.DETALLE.toLowerCase().includes(v) ||
    data.MARCA.toLowerCase().includes(v) ||
    data.FAMILIA.toLowerCase().includes(v)
  );
}

/* ================= TABULATOR ================= */
let table=new Tabulator("#table",{
  layout:"fitColumns",
  placeholder:"Sin datos",
  columns:[
    {title:"Código",field:"CODIGO",width:120,
      formatter:c=>highlight(c.getValue())},
    {title:"Nombre",field:"NOMBRE",minWidth:160,
      formatter:c=>highlight(c.getValue())},
    {title:"Detalle",field:"DETALLE",minWidth:240,
      formatter:c=>highlight(c.getValue())},
    {title:"Cantidad",field:"CANTIDAD",hozAlign:"right",width:120},
    {title:"Marca",field:"MARCA",width:140,
      formatter:c=>highlight(c.getValue())},
    {title:"Familia",field:"FAMILIA",width:140,
      formatter:c=>highlight(c.getValue())},
    {
      title:"Foto",field:"FOTO",width:110,hozAlign:"center",
      formatter:c=>{
        const src=driveImg(c.getValue());
        return src?`<img loading="lazy" src="${src}"
          style="width:70px;height:70px;object-fit:cover;border-radius:10px">`:"";
      }
    }
  ]
});

/* ================= RESALTADO ================= */
function highlight(text){
  if(!searchValue) return text||"";
  const re=new RegExp(`(${searchValue})`,"gi");
  return String(text||"").replace(re,"<mark>$1</mark>");
}

/* ================= CARGA ================= */
async function loadAny(){
  for(const url of CANDIDATES){
    try{
      const res=await fetch(url,{cache:"no-store"});
      if(!res.ok) throw 0;
      const text=await res.text();
      const wb=XLSX.read(text,{type:"string"});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const raw=XLSX.utils.sheet_to_json(ws,{defval:""});

      const rows=raw.map(r=>({
        CODIGO:pick(r,["CODIGO","ID","SKU"]).toString(),
        NOMBRE:pick(r,["NOMBRE","PRODUCTO","ITEM"]).toString(),
        DETALLE:pick(r,["DETALLE","DESCRIPCION"]).toString(),
        MARCA:pick(r,["MARCA"]).toString(),
        FAMILIA:pick(r,["FAMILIA","CATEGORIA"]).toString(),
        CANTIDAD:Number(pick(r,["CANTIDAD","QTY"]))||0,
        FOTO:pick(r,["FOTO","IMAGEN","URL_FOTO"]).toString(),
        ESTATUS2:pick(r,["ESTATUS2","ESTADO","BLOQUEO"]).toString(),
      }));

      table.replaceData(rows);
      table.setFilter(filtroGlobal);
      updateCounter();
      return;
    }catch(e){}
  }
}

/* ================= CONTADOR ================= */
function updateCounter(){
  document.getElementById("counter").textContent=
    `Visibles: ${table.getRows(true).length}`;
}

/* ================= BUSCADOR ================= */
document.getElementById("q").addEventListener("input",e=>{
  searchValue=(e.target.value||"").trim().toLowerCase();
  table.setFilter(filtroGlobal);
  updateCounter();
});

/* ================= AGRUPACIÓN ================= */
document.getElementById("groupBy").addEventListener("change",e=>{
  if(e.target.value==="none") table.setGroupBy();
  else table.setGroupBy(e.target.value);
  updateCounter();
});

/* ================= EXPORTAR ================= */
document.getElementById("exportBtn").onclick=()=>{
  table.download("xlsx","inventario_visibles.xlsx",{
    sheetName:"Visibles",
    rowRange:"active"
  });
};

loadAny();
</script>
</body>
</html>
