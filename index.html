<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario â€“ Google Sheets</title>

<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npmtabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1220; --card:#121a2b; --soft:#1b2741; --text:#e9eefb;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{max-width:1300px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;padding:16px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
.toolbar input,.toolbar select,.btn{
  background:var(--soft);border:none;color:white;
  padding:8px 12px;border-radius:10px
}
.btn{background:#2a7ef0;font-weight:600;cursor:pointer}
.counter{margin-left:auto;font-weight:600}
#table{height:620px;border-radius:12px;overflow:hidden}

/* ðŸ”´ Estilo bloqueados */
.row-bloqueado{
  opacity:.35;
  filter:grayscale(100%);
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Inventario desde Google Sheets</h2>

    <div class="toolbar">
      <input id="q" placeholder="Buscarâ€¦">
      <select id="groupBy">
        <option value="none">Sin agrupaciÃ³n</option>
        <option value="FAMILIA">Familia</option>
        <option value="MARCA">Marca</option>
      </select>

      <button id="toggleBloq" class="btn">Mostrar bloqueados</button>
      <button id="exportBtn" class="btn">Exportar disponibles</button>

      <div class="counter" id="counter">Disponibles: 0</div>
    </div>

    <div id="table"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SOURCES=[
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUkpzEC6aZsl0Ur9f3Jwu3NcuZBq2tzrT_weH8QamLt7qsvJMzUKWkZfc-xNX7Pw/pub?output=csv"
];

let mostrarBloqueados=false;
let totalDisponibles=0;

/* ================= HELPERS ================= */
function pick(row, aliases){
  for(const a of aliases){
    for(const k of Object.keys(row)){
      if(!k) continue;
      const kk=k.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      const aa=a.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase().trim();
      if(kk===aa) return row[k];
    }
  }
  return "";
}

function driveImg(url){
  if(!url) return "";
  const m=url.match(/\/file\/d\/([^/]+)\//);
  return m?`https://drive.google.com/uc?export=view&id=${m[1]}`:url;
}

/* ================= TABULATOR ================= */
let table=new Tabulator("#table",{
  layout:"fitColumns",
  placeholder:"Sin datos",

  /* ðŸ”´ OCULTA / ESTILIZA FILAS BLOQUEADAS */
  rowFormatter:function(row){
    const d=row.getData();
    const estatus=(d.ESTATUS2||"").toString().trim().toUpperCase();

    if(estatus==="BLOQUEO"){
      row.getElement().classList.add("row-bloqueado");
      if(!mostrarBloqueados){
        row.getElement().style.display="none";
      }
    }
  },

  columns:[
    {title:"CÃ³digo",field:"CODIGO",width:120},
    {title:"Nombre",field:"NOMBRE",minWidth:180},
    {title:"Detalle",field:"DETALLE",minWidth:260},
    {title:"Cantidad",field:"CANTIDAD",width:100,hozAlign:"right"},
    {title:"Marca",field:"MARCA",width:140},
    {title:"Familia",field:"FAMILIA",width:140},
    {
      title:"Foto",field:"FOTO",width:110,hozAlign:"center",
      formatter:function(cell){
        const src=driveImg(cell.getValue());
        return src
          ? `<img loading="lazy" src="${src}" style="width:70px;height:70px;object-fit:cover;border-radius:10px">`
          : "";
      }
    }
  ]
});

/* ================= CARGA ================= */
async function loadData(){
  const res=await fetch(SOURCES[0],{cache:"no-store"});
  const text=await res.text();
  const wb=XLSX.read(text,{type:"string"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const raw=XLSX.utils.sheet_to_json(ws,{defval:""});

  totalDisponibles=0;

  const rows=raw.map(r=>{
    const estatus=pick(r,["ESTATUS2","ESTADO","BLOQUEO"]).toString();
    if(estatus.toUpperCase()!=="BLOQUEO") totalDisponibles++;

    return{
      CODIGO:pick(r,["CODIGO","ID","SKU"]),
      NOMBRE:pick(r,["NOMBRE","PRODUCTO"]),
      DETALLE:pick(r,["DETALLE","DESCRIPCION"]),
      MARCA:pick(r,["MARCA"]),
      FAMILIA:pick(r,["FAMILIA","CATEGORIA"]),
      CANTIDAD:Number(pick(r,["CANTIDAD","QTY"]))||0,
      FOTO:pick(r,["FOTO","IMAGEN","URL_FOTO"]),
      ESTATUS2:estatus
    };
  });

  table.replaceData(rows);
  document.getElementById("counter").textContent=`Disponibles: ${totalDisponibles}`;
}

/* ================= EVENTOS ================= */
document.getElementById("toggleBloq").onclick=()=>{
  mostrarBloqueados=!mostrarBloqueados;
  table.redraw(true);
  document.getElementById("toggleBloq").textContent=
    mostrarBloqueados?"Ocultar bloqueados":"Mostrar bloqueados";
};

document.getElementById("exportBtn").onclick=()=>{
  table.download("xlsx","inventario_disponibles.xlsx",{
    sheetName:"Disponibles",
    rowRange:"active"
  });
};

document.getElementById("q").oninput=e=>{
  const v=e.target.value.toLowerCase();
  table.setFilter(data=>
    data.CODIGO.toLowerCase().includes(v)||
    data.NOMBRE.toLowerCase().includes(v)||
    data.DETALLE.toLowerCase().includes(v)
  );
};

document.getElementById("groupBy").onchange=e=>{
  if(e.target.value==="none") table.setGroupBy();
  else table.setGroupBy(e.target.value);
};

loadData();
</script>
</body>
</html>
