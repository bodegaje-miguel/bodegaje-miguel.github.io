<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario â€“ Google Sheets</title>

<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1220;
  --card:#121a2b;
  --soft:#1b2741;
  --text:#e9eefb;
  --hl:#ffd54f;
}

body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  width:100%;
  max-width:1800px;
  margin:16px auto;
  padding:0 12px;
}

.card{
  background:var(--card);
  border:1px solid var(--soft);
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
}

/* ===== dashboard ===== */
.dashboard{
  display:flex;
  gap:16px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.kpi{
  background:var(--soft);
  border-radius:12px;
  padding:10px 14px;
  font-weight:600;
}
.kpi.red{color:#ff5252}
.kpi.orange{color:#ff9800}

/* ===== toolbar ===== */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  margin-bottom:12px;
}

.toolbar .field{
  display:flex;
  gap:8px;
  align-items:center;
  background:var(--soft);
  border-radius:12px;
  padding:6px 10px;
}

.toolbar input,
.toolbar select{
  background:transparent;
  border:none;
  outline:none;
  color:var(--text);
  min-width:160px;
}

.btn{
  background:#2a7ef0;
  color:white;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
}

.counter{
  margin-left:auto;
  font-weight:600;
}

#table{
  height:calc(100vh - 300px);
  min-height:420px;
  border-radius:12px;
  overflow:hidden;
}

/* ===== stock ===== */
.stock-0{color:#ff5252;font-weight:700}
.stock-low{color:#ff9800;font-weight:700}
.stock-mid{color:#ffb300;font-weight:700}
.stock-high{color:#4caf50;font-weight:700}

/* ===== resaltado ===== */
mark{
  background:var(--hl);
  color:black;
  border-radius:3px;
  padding:0 2px;
}

/* ===== modo compacto ===== */
.tabulator-row .tabulator-cell{
  padding:4px 6px !important;
  font-size:13px;
}

/* ===== responsive mÃ³vil ===== */
@media (max-width:768px){
  .toolbar{
    flex-direction:column;
    align-items:stretch;
  }

  .toolbar .field,
  .btn,
  .counter{
    width:100%;
    justify-content:space-between;
  }

  .counter{
    text-align:right;
  }
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h2>Inventario</h2>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="kpi" id="kpi-total">ðŸ“¦ Visibles: 0</div>
  <div class="kpi red" id="kpi-zero">ðŸ”´ Sin stock: 0</div>
  <div class="kpi orange" id="kpi-low">ðŸŸ  Stock bajo: 0</div>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="field">
    <input id="q" placeholder="Buscarâ€¦">
  </div>

  <div class="field">
    <span>Agrupar:</span>
    <select id="groupBy">
      <option value="none">Sin agrupaciÃ³n</option>
      <option value="FAMILIA">Familia</option>
      <option value="MARCA">Marca</option>
    </select>
  </div>

  <button id="exportBtn" class="btn">Exportar visibles</button>
  <div class="counter" id="counter">0</div>
</div>

<div id="table"></div>

</div>
</div>

<script>
const SOURCE="https://docs.google.com/spreadsheets/d/e/2PACX-1vTUkpzEC6aZsl0Ur9f3Jwu3NcuZBq2tzrT_weH8QamLt7qsvJMzUKWkZfc-xNX7Pw/pub?output=csv";

let searchValue="";

/* helpers */
function pick(r,a){
  for(const x of a){
    for(const k of Object.keys(r)){
      if(k && k.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase()
        === x.normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase()){
        return r[k];
      }
    }
  }
  return "";
}
function img(url){
  if(!url) return "";
  const m=url.match(/\/file\/d\/([^/]+)\//);
  return m?`https://drive.google.com/uc?export=view&id=${m[1]}`:url;
}

/* filtro global */
function filtro(d){
  if((d.ESTATUS2||"").toUpperCase()==="BLOQUEO") return false;
  if(!searchValue) return true;
  return (
    d.CODIGO.toLowerCase().includes(searchValue) ||
    d.NOMBRE.toLowerCase().includes(searchValue) ||
    d.DETALLE.toLowerCase().includes(searchValue) ||
    d.MARCA.toLowerCase().includes(searchValue) ||
    d.FAMILIA.toLowerCase().includes(searchValue)
  );
}

/* resaltado */
function hl(t){
  if(!searchValue) return t||"";
  return String(t).replace(new RegExp(`(${searchValue})`,"gi"),"<mark>$1</mark>");
}

/* stock */
function stockFmt(c){
  const v=c.getValue();
  if(v===0) return `<span class="stock-0">ðŸ”´ 0</span>`;
  if(v<=5) return `<span class="stock-low">ðŸŸ  ${v}</span>`;
  if(v<=20) return `<span class="stock-mid">ðŸŸ¡ ${v}</span>`;
  return `<span class="stock-high">ðŸŸ¢ ${v}</span>`;
}

/* tabla */
let table=new Tabulator("#table",{
  layout:"fitColumns",
  height:"100%",
  virtualDom:true,
  responsiveLayout:"hide",
  placeholder:"Sin datos",
  columns:[
    {title:"CÃ³digo",field:"CODIGO",width:110,formatter:c=>hl(c.getValue())},
    {title:"Nombre",field:"NOMBRE",minWidth:160,formatter:c=>hl(c.getValue())},
    {title:"Detalle",field:"DETALLE",minWidth:220,formatter:c=>hl(c.getValue()),responsive:2},
    {title:"Stock",field:"CANTIDAD",width:110,formatter:stockFmt},
    {title:"Marca",field:"MARCA",width:120,formatter:c=>hl(c.getValue())},
    {title:"Familia",field:"FAMILIA",width:120,formatter:c=>hl(c.getValue()),responsive:3},
    {
      title:"Foto",
      field:"FOTO",
      width:80,
      hozAlign:"center",
      formatter:c=>{
        const s=img(c.getValue());
        return s?`<img loading="lazy" src="${s}"
          style="width:56px;height:56px;object-fit:cover;border-radius:8px">`:"";
      }
    }
  ]
});

/* dashboard + contador */
function updateDashboard(){
  const data=table.getData("active");
  let zero=0, low=0;
  data.forEach(d=>{
    if(d.CANTIDAD===0) zero++;
    else if(d.CANTIDAD<=5) low++;
  });

  document.getElementById("counter").textContent=`${data.length}`;
  document.getElementById("kpi-total").textContent=`ðŸ“¦ Visibles: ${data.length}`;
  document.getElementById("kpi-zero").textContent=`ðŸ”´ Sin stock: ${zero}`;
  document.getElementById("kpi-low").textContent=`ðŸŸ  Stock bajo: ${low}`;
}

/* carga */
async function load(){
  const r=await fetch(SOURCE,{cache:"no-store"});
  const t=await r.text();
  const wb=XLSX.read(t,{type:"string"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const raw=XLSX.utils.sheet_to_json(ws,{defval:""});

  const rows=raw.map(x=>({
    CODIGO:pick(x,["CODIGO","ID","SKU"]).toString(),
    NOMBRE:pick(x,["NOMBRE","PRODUCTO"]).toString(),
    DETALLE:pick(x,["DETALLE","DESCRIPCION"]).toString(),
    MARCA:pick(x,["MARCA"]).toString(),
    FAMILIA:pick(x,["FAMILIA","CATEGORIA"]).toString(),
    CANTIDAD:Number(pick(x,["CANTIDAD","QTY"]))||0,
    FOTO:pick(x,["FOTO","IMAGEN","URL_FOTO"]).toString(),
    ESTATUS2:pick(x,["ESTATUS2","ESTADO","BLOQUEO"]).toString()
  }));

  table.replaceData(rows);
  table.setFilter(filtro);
  updateDashboard();
}

/* eventos */
document.getElementById("q").oninput=e=>{
  searchValue=(e.target.value||"").toLowerCase();
  table.setFilter(filtro);
  updateDashboard();
};

document.getElementById("groupBy").onchange=e=>{
  if(e.target.value==="none") table.setGroupBy();
  else table.setGroupBy(e.target.value);
  updateDashboard();
};

document.getElementById("exportBtn").onclick=()=>{
  table.download("xlsx","inventario_visibles.xlsx",{rowRange:"active"});
};

load();
</script>
</body>
</html>
